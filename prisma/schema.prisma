// Prisma Schema para Postgres (Supabase / Neon / Vercel Postgres)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Para conexões serverless (importante!)
  directUrl = env("DIRECT_URL")
}

// Tabela de admins
model Admin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String   // bcrypt hash
  requiresPasswordChange Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Preferências de gráficos
  chartConfigs ChartConfig[]

  @@map("admins")
}

// Tabela de visitantes
model Visitor {
  id        String   @id @default(cuid())
  fingerprint String @unique
  sessionId String?
  ipAddress String?
  country   String?
  city      String?
  latitude  Float?
  longitude Float?
  userAgent String?
  browser   String?
  os        String?
  device    String?
  language  String?
  timezone  String?
  screenResolution String?
  referrer  String?
  firstVisitAt DateTime @default(now())
  lastVisitAt  DateTime @updatedAt
  visitCount   Int @default(1)
  totalTimeSpent Int @default(0) // em segundos
  lastPage   String?
  
  // Relações
  pageViews    PageView[]
  events       Event[]
  registrations Registration[]

  @@map("visitors")
  @@index([fingerprint])
  @@index([sessionId])
}

// Tabela de registros
model Registration {
  id        String   @id @default(cuid())
  visitorId String
  name      String
  phone     String
  email     String
  source    String?
  createdAt DateTime @default(now())
  
  visitor   Visitor  @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@map("registrations")
  @@index([visitorId])
  @@index([email])
}

// Tabela de eventos
model Event {
  id        String   @id @default(cuid())
  visitorId String
  eventName String
  category  String?
  label     String?
  value     String?
  metadata  Json?
  createdAt DateTime @default(now())
  
  visitor   Visitor  @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@map("events")
  @@index([visitorId])
  @@index([eventName])
  @@index([createdAt])
}

// Tabela de visualizações de página
model PageView {
  id        String   @id @default(cuid())
  visitorId String
  page      String
  title     String?
  timeSpent Int @default(0) // em segundos
  scrollDepth Int @default(0) // percentual 0-100
  createdAt DateTime @default(now())
  
  visitor   Visitor  @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@map("page_views")
  @@index([visitorId])
  @@index([page])
  @@index([createdAt])
}

// Tabela de configurações de gráficos
model ChartConfig {
  id        String   @id @default(cuid())
  adminId   String
  configData Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  admin     Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("chart_configs")
  @@unique([adminId])
}
